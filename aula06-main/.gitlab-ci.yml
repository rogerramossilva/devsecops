stages:
  - scan

variables:
  TRIVY_NON_SSL: "true"

# 1. AnÃ¡lise de Imagem Docker
scan:image:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - echo "ðŸ“¦ Escaneando imagem Docker"
    - docker pull alpine:3.18
    - trivy image --exit-code 0 --severity HIGH,CRITICAL alpine:3.18
  rules:
    - when: always

# 2. AnÃ¡lise de Sistema de Arquivos (diretÃ³rio atual)
scan:filesystem:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - echo "ðŸ“‚ Escaneando sistema de arquivos local"
    - trivy fs --scanners vuln,secret,config --exit-code 0 .
  rules:
    - when: always

# 3. AnÃ¡lise de RepositÃ³rio Git
scan:repo:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - echo "ðŸ”— Escaneando repositÃ³rio remoto"
    - trivy repo https://github.com/aquasecurity/trivy
  rules:
    - when: always

# 4. AnÃ¡lise de IaC (Infraestrutura como CÃ³digo)
scan:iac:
  stage: scan
  image: aquasec/trivy:latest
  script:
    - echo "ðŸ—ï¸ Escaneando IaC (Dockerfile e YAML)"
    - mkdir iac
    - echo "FROM alpine" > iac/Dockerfile
    - trivy config iac/
  rules:
    - when: always

